<!DOCTYPE html>
<html>
<head>
<title>Вход в приложение</title>
<!-- Загружаем SDK Telegram API -->
<script src="https://telegram.org"></script>
</head>
<body>
    <h1>Загрузка и авторизация через Telegram...</h1>
    
    <script>
        // Ждем, пока страница полностью загрузится И появится объект Telegram
        window.onload = function() {
            if (window.Telegram && window.Telegram.WebApp) {
                const initData = window.Telegram.WebApp.initData;

                // Отправляем данные на наш сервер Flask
                fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ initData: initData })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.token) {
                        localStorage.setItem('user_token', data.token);
                        window.location.href = "/dashboard.html"; 
                    } else {
                        alert("Ошибка входа: " + data.error);
                    }
                })
                .catch(err => {
                    console.error(err);
                    document.body.innerHTML = "Ошибка сети при входе.";
                });
            } else {
                document.body.innerHTML = "Пожалуйста, откройте это в приложении Telegram (ошибка инициализации API).";
            }
        };
    </script>
</body>
</html>
